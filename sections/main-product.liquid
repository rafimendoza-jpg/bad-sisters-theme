{%- comment -%}
  Section: Main Product — Rediseñado
  - Galería sticky a la izquierda (scroll vertical de imágenes)
  - Info a la derecha: título, estrellas, precio, tallas prominent, add to cart
  - Tabs: Descripción | Detalles | Reseñas (reseñas NO enterradas al fondo)
{%- endcomment -%}

{%- assign current_variant = product.selected_or_first_available_variant -%}
{%- assign review_rating = product.metafields.reviews.rating.value | default: 0 -%}
{%- assign review_count = product.metafields.reviews.rating_count.value | default: 0 -%}

<section class="pp" data-section-id="{{ section.id }}">
  <div class="page-width">
    <nav class="pp-breadcrumb" aria-label="Breadcrumb">
      <a href="/">Inicio</a>
      <span>/</span>
      {%- if collection -%}
        <a href="{{ collection.url }}">{{ collection.title }}</a>
        <span>/</span>
      {%- endif -%}
      <span>{{ product.title }}</span>
    </nav>

    {%- if product != blank -%}
      <div class="pp-layout">

        {%- comment -%} ===== GALLERY (Left, Sticky) ===== {%- endcomment -%}
        <div class="pp-gallery">
          <div class="pp-gallery__grid" id="ProductGallery">
            {%- for image in product.images -%}
              <div class="pp-gallery__item{% if forloop.first %} is-active{% endif %}" data-index="{{ forloop.index0 }}">
                <img
                  src="{{ image | image_url: width: 1200 }}"
                  srcset="{{ image | image_url: width: 400 }} 400w, {{ image | image_url: width: 600 }} 600w, {{ image | image_url: width: 800 }} 800w, {{ image | image_url: width: 1000 }} 1000w, {{ image | image_url: width: 1200 }} 1200w"
                  sizes="(max-width: 767px) 100vw, 50vw"
                  alt="{{ image.alt | default: product.title }}"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  {% if forloop.first %}fetchpriority="high"{% endif %}
                  decoding="async"
                  width="{{ image.width }}"
                  height="{{ image.height }}"
                  class="pp-gallery__img"
                  data-zoom-src="{{ image | image_url: width: 2048 }}"
                  onclick="openProductZoom(this)"
                >
              </div>
            {%- endfor -%}
            {%- if product.images.size == 0 -%}
              <div class="pp-gallery__item">
                {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
              </div>
            {%- endif -%}
          </div>

          {%- if product.images.size > 1 -%}
            <div class="pp-gallery__thumbs">
              {%- for image in product.images -%}
                <button
                  class="pp-gallery__thumb{% if forloop.first %} is-active{% endif %}"
                  data-index="{{ forloop.index0 }}"
                  onclick="scrollToProductImage({{ forloop.index0 }})"
                  aria-label="Imagen {{ forloop.index }}"
                >
                  <img src="{{ image | image_url: width: 100 }}" alt="{{ image.alt | default: product.title }}" loading="lazy">
                </button>
              {%- endfor -%}
            </div>
          {%- endif -%}
        </div>

        {%- comment -%} ===== PRODUCT INFO (Right, Sticky) ===== {%- endcomment -%}
        <div class="pp-info">
          {%- if section.settings.show_vendor and product.vendor != blank -%}
            <p class="pp-info__vendor">{{ product.vendor }}</p>
          {%- endif -%}

          <h1 class="pp-info__title">{{ product.title }}</h1>

          {%- comment -%} ★★★★★ STAR RATING — Prominente, justo debajo del título {%- endcomment -%}
          <div class="pp-info__rating" id="ProductRating">
            {% render 'star-rating', rating: review_rating, count: review_count, show_count: true, size: 'medium' %}
            {%- if review_count > 0 -%}
              <a href="#ProductReviewsTab" class="pp-info__rating-link" onclick="openProductTab('reviews')">
                Ver {{ review_count }} {% if review_count == 1 %}reseña{% else %}reseñas{% endif %}
              </a>
            {%- else -%}
              <a href="#ProductReviewsTab" class="pp-info__rating-link" onclick="openProductTab('reviews')">
                Escribir reseña
              </a>
            {%- endif -%}
          </div>

          {%- comment -%} PRICE {%- endcomment -%}
          <div class="pp-info__price">
            {%- if product.compare_at_price > product.price -%}
              <span class="pp-info__price-current pp-info__price-current--sale">{{ product.price | money }}</span>
              <span class="pp-info__price-compare">{{ product.compare_at_price | money }}</span>
              <span class="pp-info__price-badge">
                -{{ product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round }}%
              </span>
            {%- else -%}
              <span class="pp-info__price-current">{{ product.price | money }}</span>
            {%- endif -%}
            {%- if current_variant.unit_price -%}
              <span class="pp-info__unit-price">
                {{ current_variant.unit_price | money }} / {{ current_variant.unit_price_measurement.reference_value }}{{ current_variant.unit_price_measurement.reference_unit }}
              </span>
            {%- endif -%}
          </div>

          {%- comment -%} BSD POINTS ESTIMATE {%- endcomment -%}
          {%- render 'bsd-points-line', cents: current_variant.price -%}

          {%- comment -%} PRODUCT FORM {%- endcomment -%}
          {%- form 'product', product -%}

            {%- comment -%} VARIANT OPTIONS — Tallas prominentes {%- endcomment -%}
            {%- unless product.has_only_default_variant -%}
              {%- for option in product.options_with_values -%}
                {%- assign option_name_lower = option.name | downcase -%}
                <div class="pp-option">
                  <div class="pp-option__header">
                    <span class="pp-option__label">{{ option.name }}</span>
                    <span class="pp-option__selected" id="OptionSelected{{ forloop.index0 }}">{{ option.selected_value }}</span>
                  </div>

                  {%- if option_name_lower == 'color' or option_name_lower == 'colour' -%}
                    {%- comment -%} Color swatches {%- endcomment -%}
                    <div class="pp-option__colors">
                      {%- for value in option.values -%}
                        <button
                          type="button"
                          class="pp-color-swatch{% if forloop.first %} is-selected{% endif %}"
                          data-option-index="{{ forloop.parentloop.index0 }}"
                          data-value="{{ value }}"
                          title="{{ value }}"
                          style="background-color: {{ value | handleize }};"
                          onclick="selectProductOption(this)"
                        >
                          <span class="visually-hidden">{{ value }}</span>
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- elsif option_name_lower == 'size' or option_name_lower == 'talla' or option_name_lower == 'tamaño' -%}
                    {%- comment -%} Size buttons — BIG and prominent {%- endcomment -%}
                    <div class="pp-option__sizes">
                      {%- for value in option.values -%}
                        {%- assign size_available = true -%}
                        {%- for variant in product.variants -%}
                          {%- if variant.option1 == value or variant.option2 == value or variant.option3 == value -%}
                            {%- unless variant.available -%}{%- assign size_available = false -%}{%- endunless -%}
                          {%- endif -%}
                        {%- endfor -%}
                        <button
                          type="button"
                          class="pp-size-btn{% if forloop.first %} is-selected{% endif %}{% unless size_available %} is-disabled{% endunless %}"
                          data-option-index="{{ forloop.parentloop.index0 }}"
                          data-value="{{ value }}"
                          onclick="selectProductOption(this)"
                          {% unless size_available %}aria-disabled="true"{% endunless %}
                        >
                          {{ value }}
                        </button>
                      {%- endfor -%}
                    </div>
                    {%- if section.settings.show_size_guide -%}
                      <a href="#" class="pp-size-guide" onclick="event.preventDefault(); document.getElementById('SizeGuideModal').classList.add('is-open');">
                        Guía de tallas
                      </a>
                    {%- endif -%}
                  {%- else -%}
                    {%- comment -%} Generic options {%- endcomment -%}
                    <div class="pp-option__buttons">
                      {%- for value in option.values -%}
                        <button
                          type="button"
                          class="pp-option-btn{% if forloop.first %} is-selected{% endif %}"
                          data-option-index="{{ forloop.parentloop.index0 }}"
                          data-value="{{ value }}"
                          onclick="selectProductOption(this)"
                        >
                          {{ value }}
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endfor -%}
            {%- endunless -%}

            <select name="id" class="visually-hidden" id="ProductVariantSelect" aria-label="Variante">
              {%- for variant in product.variants -%}
                <option
                  value="{{ variant.id }}"
                  {% if variant == current_variant %}selected{% endif %}
                  {% unless variant.available %}disabled{% endunless %}
                  data-price="{{ variant.price | money }}"
                  data-compare-price="{{ variant.compare_at_price | money }}"
                  data-available="{{ variant.available }}"
                  data-raw-price="{{ variant.price }}"
                  data-inventory="{{ variant.inventory_quantity | default: 0 }}"
                >
                  {{ variant.title }} - {{ variant.price | money }}
                </option>
              {%- endfor -%}
            </select>

            {%- comment -%} LOW STOCK WARNING {%- endcomment -%}
            {%- assign cv_qty = current_variant.inventory_quantity | default: 0 -%}
            <div class="pp-low-stock" data-low-stock style="{% if cv_qty >= 3 or cv_qty <= 0 %}display:none{% endif %}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              Solo{% if cv_qty == 1 %} queda <strong>1</strong> unidad{% else %} quedan <strong data-low-stock-qty>{{ cv_qty }}</strong> unidades{% endif %}
            </div>

            {%- comment -%} ADD TO CART {%- endcomment -%}
            <div class="pp-add-row">
              <div class="pp-quantity">
                <button type="button" class="pp-quantity__btn" data-action="decrease" aria-label="Menos">−</button>
                <input type="number" name="quantity" value="1" min="1" class="pp-quantity__input" aria-label="Cantidad">
                <button type="button" class="pp-quantity__btn" data-action="increase" aria-label="Más">+</button>
              </div>
              <button type="submit" class="pp-add-btn"
                {% unless product.available %}disabled{% endunless %}
                id="ProductAddToCart">
                {%- if product.available -%}
                  Agregar al carrito — {{ current_variant.price | money }}
                {%- else -%}
                  Agotado
                {%- endif -%}
              </button>
              <button type="button" class="pp-wishlist-btn" data-wishlist-btn="{{ product.handle }}" aria-label="Agregar a favoritos">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              </button>
            </div>

          {%- endform -%}

          {%- comment -%} PEDIDO ESPECIAL (Custom Order) — enabled via metafield bsd.custom_order {%- endcomment -%}
          {%- if product.metafields.bsd.custom_order.value == true -%}
            <button type="button" class="pp-custom-order-btn" onclick="document.getElementById('CustomOrderModal').classList.add('is-open');">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
              Pedido Especial
            </button>
          {%- endif -%}

          {%- comment -%} TRUST BADGES {%- endcomment -%}
          {%- if section.settings.show_trust_badges -%}
            <div class="pp-trust">
              <div class="pp-trust__item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span>Compra segura</span>
              </div>
              <div class="pp-trust__item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                <span>Envío rápido</span>
              </div>
              <div class="pp-trust__item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                <span>Devoluciones fáciles</span>
              </div>
            </div>
          {%- endif -%}

          {%- comment -%} SHARE ROW {%- endcomment -%}
          {%- if section.settings.show_share -%}
            <div class="pp-share-row">
              <span class="pp-share-row__label">Compartir</span>
              <div class="pp-share-row__icons">
                <a href="https://wa.me/?text={{ product.title | url_encode }}%20{{ shop.url }}{{ product.url | url_encode }}" target="_blank" rel="noopener" class="pp-share-row__icon" aria-label="WhatsApp" title="WhatsApp">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </a>
                <button class="pp-share-row__icon" aria-label="Copiar enlace" title="Copiar enlace" onclick="navigator.clipboard.writeText('{{ shop.url }}{{ product.url }}').then(() => { this.classList.add('is-copied'); setTimeout(() => this.classList.remove('is-copied'), 2000); })">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                </button>
              </div>
            </div>
          {%- endif -%}

          {%- comment -%} ===== TABS: Descripción | Detalles | Reseñas ===== {%- endcomment -%}
          <div class="pp-tabs" id="ProductTabs">
            <div class="pp-tabs__nav">
              <button class="pp-tab-btn is-active" onclick="openProductTab('description')" data-tab="description">
                Descripción
              </button>
              {%- if section.settings.show_details_tab -%}
                <button class="pp-tab-btn" onclick="openProductTab('details')" data-tab="details">
                  Detalles
                </button>
              {%- endif -%}
              <button class="pp-tab-btn" onclick="openProductTab('reviews')" data-tab="reviews">
                Reseñas
                {%- if review_count > 0 -%}
                  <span class="pp-tab-count">{{ review_count }}</span>
                {%- endif -%}
              </button>
            </div>

            <div class="pp-tabs__content">
              {%- comment -%} Tab: Descripción {%- endcomment -%}
              <div class="pp-tab-panel is-active" data-panel="description">
                {%- if product.description != blank -%}
                  <div class="rte">{{ product.description }}</div>
                {%- else -%}
                  <p>No hay descripción disponible.</p>
                {%- endif -%}
              </div>

              {%- comment -%} Tab: Detalles {%- endcomment -%}
              {%- if section.settings.show_details_tab -%}
                <div class="pp-tab-panel" data-panel="details">
                  <table class="pp-details-table">
                    {%- if product.type != blank -%}
                      <tr><th>Tipo</th><td>{{ product.type }}</td></tr>
                    {%- endif -%}
                    {%- if product.vendor != blank -%}
                      <tr><th>Marca</th><td>{{ product.vendor }}</td></tr>
                    {%- endif -%}
                    {%- if current_variant.sku != blank -%}
                      <tr><th>SKU</th><td>{{ current_variant.sku }}</td></tr>
                    {%- endif -%}
                    {%- if current_variant.barcode != blank -%}
                      <tr><th>Código de barras</th><td>{{ current_variant.barcode }}</td></tr>
                    {%- endif -%}
                    {%- if current_variant.weight > 0 -%}
                      <tr><th>Peso</th><td>{{ current_variant.weight | weight_with_unit: current_variant.weight_unit }}</td></tr>
                    {%- endif -%}
                    {%- for tag in product.tags -%}
                      {%- if tag contains 'Material:' -%}
                        <tr><th>Material</th><td>{{ tag | split: ':' | last | strip }}</td></tr>
                      {%- endif -%}
                      {%- if tag contains 'Cuidado:' -%}
                        <tr><th>Cuidado</th><td>{{ tag | split: ':' | last | strip }}</td></tr>
                      {%- endif -%}
                    {%- endfor -%}
                  </table>
                </div>
              {%- endif -%}

              {%- comment -%} Tab: Reseñas — ¡AQUÍ SE VEN! No están enterradas {%- endcomment -%}
              <div class="pp-tab-panel" data-panel="reviews" id="ProductReviewsTab">
                {%- if review_count > 0 -%}
                  <div class="pp-reviews-summary">
                    <div class="pp-reviews-summary__stars">
                      <span class="pp-reviews-big-number">{{ review_rating | round: 1 }}</span>
                      {% render 'star-rating', rating: review_rating, count: review_count, show_count: false, size: 'large' %}
                    </div>
                    <p>Basado en {{ review_count }} {% if review_count == 1 %}reseña{% else %}reseñas{% endif %}</p>
                  </div>
                {%- endif -%}

                {%- comment -%} Review app hooks — Judge.me, Loox, Yotpo, etc. inject here {%- endcomment -%}
                <div id="shopify-product-reviews" data-id="{{ product.id }}">
                  {{ product.metafields.reviews.rating_html | default: '' }}
                  {{ product.metafields.judgeme.widget | default: '' }}
                  {{ product.metafields.loox.reviews_widget | default: '' }}
                </div>

                {%- comment -%} If no review app, show native prompt {%- endcomment -%}
                <div class="pp-reviews-native">
                  {%- if review_count == 0 -%}
                    <div class="pp-reviews-empty">
                      <p>Aún no hay reseñas para este producto.</p>
                      <p class="pp-reviews-empty__cta">¡Sé el primero en dejar tu opinión!</p>
                    </div>
                  {%- endif -%}

                  {%- comment -%} Inline review form — works for guests AND logged-in {%- endcomment -%}
                  <div class="pp-review-form-wrap" data-pdp-review-wrap>
                    <button class="pp-review-form-toggle" data-pdp-review-toggle>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                      Escribir una reseña
                    </button>

                    <div class="pp-review-form" data-pdp-review-form style="display:none;">
                      {%- unless customer -%}
                        <div class="pp-review-form__row">
                          <div class="pp-review-form__field">
                            <label for="PdpReviewName">Tu nombre</label>
                            <input type="text" id="PdpReviewName" data-pdp-review-name placeholder="Ej: María G." required>
                          </div>
                          <div class="pp-review-form__field">
                            <label for="PdpReviewEmail">Email</label>
                            <input type="email" id="PdpReviewEmail" data-pdp-review-email placeholder="tu@email.com" required>
                          </div>
                        </div>
                      {%- endunless -%}

                      <div class="pp-review-form__stars" data-pdp-star-picker>
                        <label>Calificación</label>
                        <div class="pp-review-stars">
                          {%- for i in (1..5) -%}
                            <button type="button" class="pp-review-star" data-star="{{ i }}" aria-label="{{ i }} estrellas">
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            </button>
                          {%- endfor -%}
                        </div>
                      </div>

                      <div class="pp-review-form__field">
                        <label for="PdpReviewText">Tu reseña</label>
                        <textarea id="PdpReviewText" data-pdp-review-text rows="4" placeholder="Cuéntanos tu experiencia con este producto..."></textarea>
                      </div>

                      <div class="pp-review-form__actions">
                        <button type="button" class="btn btn--secondary btn--small" data-pdp-review-cancel>Cancelar</button>
                        <button type="button" class="btn btn--primary btn--small" data-pdp-review-submit>Enviar reseña</button>
                      </div>
                      <div class="pp-review-form__msg" data-pdp-review-msg></div>
                    </div>

                    <div class="pp-review-form__success" data-pdp-review-success style="display:none;">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                      <p>¡Gracias por tu reseña! Tu opinión nos ayuda mucho.</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    {%- endif -%}
  </div>
</section>

{%- comment -%} Zoom Modal {%- endcomment -%}
<div class="pp-zoom-modal" id="ProductZoomModal" onclick="if(event.target === this) closeProductZoom();">
  <button class="pp-zoom-modal__close" onclick="closeProductZoom()" aria-label="Cerrar">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
  </button>
  <img class="pp-zoom-modal__img" id="ProductZoomImage" src="" alt="">
</div>

{%- comment -%} Size Guide Modal {%- endcomment -%}
{%- if section.settings.show_size_guide -%}
  {%- comment -%} Priority: product metafield → section setting → generic table {%- endcomment -%}
  {%- assign sg_image = product.metafields.bsd.size_guide_image.value | default: nil -%}
  {%- unless sg_image -%}
    {%- assign sg_image = section.settings.size_guide_image -%}
  {%- endunless -%}

  <div class="pp-modal" id="SizeGuideModal" onclick="if(event.target === this) this.classList.remove('is-open');">
    <div class="pp-modal__content">
      <button class="pp-modal__close" onclick="document.getElementById('SizeGuideModal').classList.remove('is-open');" aria-label="Cerrar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <h3>Guía de tallas</h3>
      {%- if sg_image != blank -%}
        <img src="{{ sg_image | image_url: width: 800 }}" srcset="{{ sg_image | image_url: width: 400 }} 400w, {{ sg_image | image_url: width: 800 }} 800w" sizes="(max-width: 600px) 90vw, 600px" alt="Guía de tallas — {{ product.title | escape }}" loading="lazy" decoding="async">
      {%- else -%}
        <p>Consulta nuestra guía de tallas para encontrar tu talla perfecta. Si tienes dudas, contáctanos.</p>
        <table class="pp-size-table">
          <thead><tr><th>Talla</th><th>Pecho (cm)</th><th>Cintura (cm)</th><th>Cadera (cm)</th></tr></thead>
          <tbody>
            <tr><td>XS</td><td>80-84</td><td>60-64</td><td>86-90</td></tr>
            <tr><td>S</td><td>84-88</td><td>64-68</td><td>90-94</td></tr>
            <tr><td>M</td><td>88-92</td><td>68-72</td><td>94-98</td></tr>
            <tr><td>L</td><td>92-96</td><td>72-76</td><td>98-102</td></tr>
            <tr><td>XL</td><td>96-100</td><td>76-80</td><td>102-106</td></tr>
          </tbody>
        </table>
      {%- endif -%}
    </div>
  </div>
{%- endif -%}

{%- comment -%} Custom Order Modal {%- endcomment -%}
{%- if product.metafields.bsd.custom_order.value == true -%}
  <div class="pp-modal" id="CustomOrderModal" onclick="if(event.target === this) this.classList.remove('is-open');">
    <div class="pp-modal__content pp-custom-order-modal">
      <button class="pp-modal__close" onclick="document.getElementById('CustomOrderModal').classList.remove('is-open');" aria-label="Cerrar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <h3 class="pp-custom-order__title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Pedido Especial
      </h3>
      <p class="pp-custom-order__subtitle">¿Necesitas una talla, estampado o personalización especial? Completa el formulario y te contactaremos.</p>

      <form id="CustomOrderForm" class="pp-custom-order-form" novalidate>
        <input type="hidden" name="product_title" value="{{ product.title | escape }}">
        <input type="hidden" name="product_url" value="{{ shop.url }}{{ product.url }}">
        <input type="hidden" name="product_id" value="{{ product.id }}">

        <div class="pp-custom-order-form__row">
          <label for="co_name">Nombre *</label>
          <input type="text" id="co_name" name="name" required
            {%- if customer %} value="{{ customer.name | escape }}"{% endif %}>
        </div>

        <div class="pp-custom-order-form__row">
          <label for="co_email">Email *</label>
          <input type="email" id="co_email" name="email" required
            {%- if customer %} value="{{ customer.email | escape }}"{% endif %}>
        </div>

        <div class="pp-custom-order-form__row">
          <label for="co_phone">Teléfono</label>
          <input type="tel" id="co_phone" name="phone"
            {%- if customer and customer.default_address %} value="{{ customer.default_address.phone | escape }}"{% endif %}>
        </div>

        <div class="pp-custom-order-form__row">
          <label for="co_type">Tipo de solicitud *</label>
          <select id="co_type" name="type" required>
            <option value="">Selecciona una opción</option>
            <option value="A medida">A medida (talla personalizada)</option>
            <option value="Estampado personalizado">Estampado personalizado</option>
            <option value="Talla especial">Talla especial</option>
            <option value="Color especial">Color especial</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="pp-custom-order-form__row">
          <label for="co_details">Detalles de tu pedido *</label>
          <textarea id="co_details" name="details" rows="4" required placeholder="Describe lo que necesitas: medidas, tipo de estampado, color, etc."></textarea>
        </div>

        <div class="pp-custom-order-form__msg" data-co-msg></div>

        <button type="submit" class="pp-custom-order-form__submit" data-co-submit>
          Enviar solicitud
        </button>

        <div class="pp-custom-order-form__success" data-co-success style="display:none;">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <p><strong>¡Solicitud enviada!</strong><br>Te contactaremos pronto para coordinar tu pedido especial.</p>
        </div>
      </form>
    </div>
  </div>
{%- endif -%}

<script>
  /* ===== Product Tabs ===== */
  function openProductTab(tab) {
    document.querySelectorAll('.pp-tab-btn').forEach(b => b.classList.remove('is-active'));
    document.querySelectorAll('.pp-tab-panel').forEach(p => p.classList.remove('is-active'));
    const btn = document.querySelector(`.pp-tab-btn[data-tab="${tab}"]`);
    const panel = document.querySelector(`.pp-tab-panel[data-panel="${tab}"]`);
    if (btn) btn.classList.add('is-active');
    if (panel) panel.classList.add('is-active');
  }

  /* ===== Variant Selector ===== */
  function selectProductOption(btn) {
    const idx = btn.dataset.optionIndex;
    const value = btn.dataset.value;

    /* Update UI */
    btn.closest('.pp-option').querySelectorAll('button[data-option-index]').forEach(b => b.classList.remove('is-selected'));
    btn.classList.add('is-selected');

    const selectedLabel = document.getElementById('OptionSelected' + idx);
    if (selectedLabel) selectedLabel.textContent = value;

    /* Find matching variant */
    const select = document.getElementById('ProductVariantSelect');
    const options = select.querySelectorAll('option');
    const selectedValues = [];
    document.querySelectorAll('button.is-selected[data-option-index]').forEach(b => {
      selectedValues[parseInt(b.dataset.optionIndex)] = b.dataset.value;
    });

    const variantTitle = selectedValues.filter(Boolean).join(' / ');
    for (const opt of options) {
      if (opt.textContent.trim().startsWith(variantTitle)) {
        select.value = opt.value;
        const addBtn = document.getElementById('ProductAddToCart');
        if (opt.disabled) {
          addBtn.disabled = true;
          addBtn.textContent = 'Agotado';
        } else {
          addBtn.disabled = false;
          addBtn.textContent = 'Agregar al carrito — ' + opt.dataset.price;
        }
        /* BSD points update */
        var rawPrice = parseInt(opt.dataset.rawPrice) || 0;
        var pts = Math.floor(rawPrice / 10000);
        var ptsEl = document.querySelector('[data-bsd-points-value]');
        var ptsLine = document.querySelector('[data-bsd-points-line]');
        if (ptsEl) ptsEl.textContent = pts;
        if (ptsLine) ptsLine.style.display = pts > 0 ? 'flex' : 'none';

        /* Low stock update */
        var inv = parseInt(opt.dataset.inventory) || 0;
        var lsEl = document.querySelector('[data-low-stock]');
        if (lsEl) {
          if (inv > 0 && inv < 3) {
            lsEl.style.display = 'flex';
            var qtyEl = lsEl.querySelector('[data-low-stock-qty]');
            if (inv === 1) {
              lsEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Solo queda <strong>1</strong> unidad';
            } else {
              lsEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Solo quedan <strong>' + inv + '</strong> unidades';
            }
          } else {
            lsEl.style.display = 'none';
          }
        }

        break;
      }
    }
  }

  /* ===== Gallery Scroll ===== */
  function scrollToProductImage(index) {
    const items = document.querySelectorAll('.pp-gallery__item');
    if (items[index]) {
      items[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    document.querySelectorAll('.pp-gallery__thumb').forEach(t => t.classList.remove('is-active'));
    const thumbs = document.querySelectorAll('.pp-gallery__thumb');
    if (thumbs[index]) thumbs[index].classList.add('is-active');
  }

  /* ===== Zoom ===== */
  function openProductZoom(img) {
    const modal = document.getElementById('ProductZoomModal');
    const zoomImg = document.getElementById('ProductZoomImage');
    zoomImg.src = img.dataset.zoomSrc || img.src;
    zoomImg.alt = img.alt;
    modal.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  }

  function closeProductZoom() {
    const modal = document.getElementById('ProductZoomModal');
    modal.classList.remove('is-open');
    document.body.style.overflow = '';
  }

  /* ===== Quantity ===== */
  document.querySelectorAll('.pp-quantity__btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = btn.parentElement.querySelector('.pp-quantity__input');
      let val = parseInt(input.value) || 1;
      if (btn.dataset.action === 'increase') val++;
      else if (btn.dataset.action === 'decrease' && val > 1) val--;
      input.value = val;
    });
  });

  /* Gallery intersection observer for thumb highlighting */
  if ('IntersectionObserver' in window) {
    const galleryObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const idx = entry.target.dataset.index;
          document.querySelectorAll('.pp-gallery__thumb').forEach(t => t.classList.remove('is-active'));
          const thumb = document.querySelector(`.pp-gallery__thumb[data-index="${idx}"]`);
          if (thumb) thumb.classList.add('is-active');
        }
      });
    }, { threshold: 0.6 });

    document.querySelectorAll('.pp-gallery__item').forEach(item => {
      galleryObserver.observe(item);
    });
  }

  /* Escape key closes modals */
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeProductZoom();
      const sizeGuide = document.getElementById('SizeGuideModal');
      if (sizeGuide) sizeGuide.classList.remove('is-open');
    }
  });

  /* ===== PDP Review Form ===== */
  (function() {
    var toggleBtn = document.querySelector('[data-pdp-review-toggle]');
    var form = document.querySelector('[data-pdp-review-form]');
    var cancelBtn = document.querySelector('[data-pdp-review-cancel]');
    var submitBtn = document.querySelector('[data-pdp-review-submit]');
    var successEl = document.querySelector('[data-pdp-review-success]');
    var picker = document.querySelector('[data-pdp-star-picker]');
    if (!toggleBtn || !form) return;

    toggleBtn.addEventListener('click', function() {
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      toggleBtn.style.display = 'none';
    });
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        form.style.display = 'none';
        toggleBtn.style.display = 'flex';
      });
    }

    /* Star picker */
    if (picker) {
      var stars = picker.querySelectorAll('[data-star]');
      stars.forEach(function(star) {
        star.addEventListener('mouseenter', function() {
          var val = parseInt(this.dataset.star);
          stars.forEach(function(s) {
            s.classList.toggle('is-hovered', parseInt(s.dataset.star) <= val);
          });
        });
        star.addEventListener('mouseleave', function() {
          stars.forEach(function(s) { s.classList.remove('is-hovered'); });
        });
        star.addEventListener('click', function() {
          var val = parseInt(this.dataset.star);
          stars.forEach(function(s) {
            s.classList.toggle('is-active', parseInt(s.dataset.star) <= val);
          });
          picker.dataset.rating = val;
        });
      });
    }

    /* Submit */
    if (submitBtn) {
      submitBtn.addEventListener('click', function() {
        var msg = document.querySelector('[data-pdp-review-msg]');
        var rating = picker ? (parseInt(picker.dataset.rating) || 0) : 0;
        var text = (document.querySelector('[data-pdp-review-text]') || {}).value || '';
        text = text.trim();

        /* Guest fields */
        var nameEl = document.querySelector('[data-pdp-review-name]');
        var emailEl = document.querySelector('[data-pdp-review-email]');
        var guestName = nameEl ? nameEl.value.trim() : '';
        var guestEmail = emailEl ? emailEl.value.trim() : '';

        /* Validation */
        if (nameEl && !guestName) { showPdpMsg(msg, 'Por favor ingresa tu nombre.', 'error'); return; }
        if (emailEl && !guestEmail) { showPdpMsg(msg, 'Por favor ingresa tu email.', 'error'); return; }
        if (rating === 0) { showPdpMsg(msg, 'Por favor selecciona una calificación.', 'error'); return; }
        if (text.length < 5) { showPdpMsg(msg, 'Por favor escribe al menos unas palabras.', 'error'); return; }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando…';

        var customerName = '{{ customer.first_name | default: "" }} {{ customer.last_name | default: "" }}'.trim();
        var customerEmail = '{{ customer.email | default: "" }}';
        var senderName = customerName || guestName;
        var senderEmail = customerEmail || guestEmail;

        var fd = new FormData();
        fd.append('form_type', 'contact');
        fd.append('utf8', '✓');
        fd.append('contact[email]', senderEmail);
        fd.append('contact[body]',
          '--- RESEÑA DE PRODUCTO ---\n' +
          'Nombre: ' + senderName + '\n' +
          'Email: ' + senderEmail + '\n' +
          'Producto: {{ product.title | escape }}\n' +
          'Handle: {{ product.handle }}\n' +
          'Product ID: {{ product.id }}\n' +
          'Calificación: ' + rating + '/5 ' + '★'.repeat(rating) + '☆'.repeat(5 - rating) + '\n' +
          'Reseña: ' + text + '\n' +
          '---'
        );

        fetch('/contact', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'application/json' }
        }).then(function() {
          form.style.display = 'none';
          if (successEl) successEl.style.display = 'flex';
        }).catch(function() {
          /* Contact form redirects — treat as success */
          form.style.display = 'none';
          if (successEl) successEl.style.display = 'flex';
        });
      });
    }

    function showPdpMsg(el, text, type) {
      if (!el) return;
      el.textContent = text;
      el.className = 'pp-review-form__msg is-' + type;
    }
  })();

  /* ===== Custom Order Form ===== */
  (function() {
    var coForm = document.getElementById('CustomOrderForm');
    if (!coForm) return;

    var submitBtn = coForm.querySelector('[data-co-submit]');
    var msgEl = coForm.querySelector('[data-co-msg]');
    var successEl = coForm.querySelector('[data-co-success]');

    coForm.addEventListener('submit', function(e) {
      e.preventDefault();

      var name = coForm.querySelector('#co_name').value.trim();
      var email = coForm.querySelector('#co_email').value.trim();
      var type = coForm.querySelector('#co_type').value;
      var details = coForm.querySelector('#co_details').value.trim();
      var phone = coForm.querySelector('#co_phone').value.trim();
      var productTitle = coForm.querySelector('[name="product_title"]').value;
      var productUrl = coForm.querySelector('[name="product_url"]').value;

      if (!name || !email || !type || !details) {
        showCoMsg(msgEl, 'Por favor completa todos los campos obligatorios.', 'error');
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showCoMsg(msgEl, 'Introduce un email válido.', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';
      if (msgEl) msgEl.style.display = 'none';

      var body = [
        '--- PEDIDO ESPECIAL ---',
        'Producto: ' + productTitle,
        'URL: ' + productUrl,
        '',
        'Tipo de solicitud: ' + type,
        'Detalles: ' + details,
        '',
        'Teléfono: ' + (phone || 'No proporcionado'),
      ].join('\n');

      var fd = new FormData();
      fd.append('form_type', 'contact');
      fd.append('utf8', '✓');
      fd.append('contact[name]', name);
      fd.append('contact[email]', email);
      fd.append('contact[phone]', phone);
      fd.append('contact[body]', body);
      fd.append('contact[Pedido Especial]', 'true');

      fetch('/contact', {
        method: 'POST',
        body: fd,
        headers: { 'Accept': 'application/json' }
      }).then(function() {
        coForm.querySelectorAll('.pp-custom-order-form__row, .pp-custom-order-form__submit').forEach(function(el) {
          el.style.display = 'none';
        });
        if (successEl) successEl.style.display = 'flex';
      }).catch(function() {
        /* Contact form redirects — treat as success */
        coForm.querySelectorAll('.pp-custom-order-form__row, .pp-custom-order-form__submit').forEach(function(el) {
          el.style.display = 'none';
        });
        if (successEl) successEl.style.display = 'flex';
      });
    });

    function showCoMsg(el, text, type) {
      if (!el) return;
      el.textContent = text;
      el.className = 'pp-custom-order-form__msg is-' + type;
      el.style.display = 'block';
    }
  })();

  /* Close Custom Order modal on Escape */
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var coModal = document.getElementById('CustomOrderModal');
      if (coModal) coModal.classList.remove('is-open');
    }
  });
</script>

{% schema %}
{
  "name": "Producto principal",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Información del producto"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Mostrar marca",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_details_tab",
      "label": "Mostrar pestaña 'Detalles'",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_share",
      "label": "Mostrar pestaña 'Compartir'",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_trust_badges",
      "label": "Mostrar insignias de confianza",
      "default": true,
      "info": "Compra segura, envío rápido, devoluciones"
    },
    {
      "type": "header",
      "content": "Guía de tallas"
    },
    {
      "type": "checkbox",
      "id": "show_size_guide",
      "label": "Mostrar 'Guía de tallas'",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "size_guide_image",
      "label": "Imagen de guía de tallas",
      "info": "Sube tu propia guía de tallas"
    }
  ]
}
{% endschema %}
