{%- comment -%}
  Section: Before / After ‚Äî Comparador interactivo de im√°genes
  Dos im√°genes superpuestas con un slider draggable para compararlas.
  Soporta mouse y touch. Ideal para antes/despu√©s, d√≠a/noche, etc.
{%- endcomment -%}

<style>
  #BA-{{ section.id }} {
    {%- if section.settings.background_color != blank and section.settings.background_color != 'rgba(0,0,0,0)' -%}
      background-color: {{ section.settings.background_color }};
    {%- endif -%}
    overflow: hidden;
  }

  #BA-{{ section.id }} .ba__header { text-align: center; margin-bottom: 2.5rem; }
  #BA-{{ section.id }} .ba__sub {
    font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--color-text-light); margin: 0 0 0.5rem;
  }
  #BA-{{ section.id }} .ba__title {
    font-size: clamp(1.5rem, 3vw, 2.5rem); font-weight: 300;
    letter-spacing: 0.1em; text-transform: uppercase; margin: 0;
  }

  /* Container */
  #BA-{{ section.id }} .ba__container {
    position: relative;
    overflow: hidden;
    border-radius: {{ section.settings.border_radius }}px;
    cursor: col-resize;
    user-select: none;
    -webkit-user-select: none;
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
  }

  /* Images */
  #BA-{{ section.id }} .ba__img {
    width: 100%;
    display: block;
  }
  #BA-{{ section.id }} .ba__before {
    position: absolute;
    inset: 0;
    overflow: hidden;
    width: {{ section.settings.initial_position }}%;
    z-index: 2;
  }
  #BA-{{ section.id }} .ba__before .ba__img {
    position: absolute;
    top: 0;
    left: 0;
    width: auto;
    min-width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #BA-{{ section.id }} .ba__after {
    position: relative;
    z-index: 1;
    width: 100%;
  }
  #BA-{{ section.id }} .ba__after .ba__img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  /* Make before image match after width */
  #BA-{{ section.id }} .ba__before .ba__img {
    width: var(--ba-container-width, 100%);
    min-width: var(--ba-container-width, 100%);
    max-width: none;
  }

  /* Slider line */
  #BA-{{ section.id }} .ba__line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #fff;
    left: {{ section.settings.initial_position }}%;
    z-index: 5;
    pointer-events: none;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
  }

  /* Handle */
  #BA-{{ section.id }} .ba__handle {
    position: absolute;
    top: 50%;
    left: {{ section.settings.initial_position }}%;
    transform: translate(-50%, -50%);
    z-index: 6;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: col-resize;
    transition: transform 0.2s ease;
  }
  #BA-{{ section.id }} .ba__handle:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }
  #BA-{{ section.id }} .ba__handle:active {
    transform: translate(-50%, -50%) scale(0.95);
  }
  #BA-{{ section.id }} .ba__handle svg {
    width: 20px;
    height: 20px;
    color: #333;
  }

  /* Labels */
  #BA-{{ section.id }} .ba__label {
    position: absolute;
    top: 1.5rem;
    z-index: 4;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #fff;
    padding: 0.4rem 1rem;
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    pointer-events: none;
  }
  #BA-{{ section.id }} .ba__label--before { left: 1.5rem; z-index: 4; }
  #BA-{{ section.id }} .ba__label--after { right: 1.5rem; z-index: 1; }

  /* Hint animation */
  @keyframes ba-hint-{{ section.id }} {
    0%, 100% { left: {{ section.settings.initial_position }}%; }
    30% { left: 35%; }
    60% { left: 65%; }
  }
  #BA-{{ section.id }}:not(.ba--interacted) .ba__handle,
  #BA-{{ section.id }}:not(.ba--interacted) .ba__line,
  #BA-{{ section.id }}:not(.ba--interacted) .ba__before {
    animation: ba-hint-{{ section.id }} 3s ease-in-out 1.5s 2;
  }

  /* Responsive */
  @media (max-width: 768px) {
    #BA-{{ section.id }} .ba__handle { width: 40px; height: 40px; }
    #BA-{{ section.id }} .ba__handle svg { width: 16px; height: 16px; }
    #BA-{{ section.id }} .ba__label { font-size: 0.6rem; padding: 0.3rem 0.7rem; }
  }
</style>

<section id="BA-{{ section.id }}" class="ba section-padding" data-section-id="{{ section.id }}">
  <div class="{% if section.settings.full_width %}ba--full{% else %}page-width{% endif %}">

    {%- if section.settings.heading != blank or section.settings.subheading != blank -%}
      <div class="ba__header"{% if section.settings.text_color != blank %} style="color: {{ section.settings.text_color }};"{% endif %}>
        {%- if section.settings.subheading != blank -%}
          <p class="ba__sub">{{ section.settings.subheading }}</p>
        {%- endif -%}
        {%- if section.settings.heading != blank -%}
          <h2 class="ba__title">{{ section.settings.heading }}</h2>
        {%- endif -%}
      </div>
    {%- endif -%}

    <div class="ba__container" data-ba="{{ section.id }}">
      {%- comment -%} AFTER image (background, full width) {%- endcomment -%}
      <div class="ba__after">
        {%- if section.settings.image_after != blank -%}
          <img
            src="{{ section.settings.image_after | image_url: width: 1600 }}"
            srcset="{{ section.settings.image_after | image_url: width: 600 }} 600w, {{ section.settings.image_after | image_url: width: 1000 }} 1000w, {{ section.settings.image_after | image_url: width: 1600 }} 1600w"
            sizes="(max-width: 768px) 100vw, {{ section.settings.max_width }}px"
            alt="{{ section.settings.label_after | default: 'Despu√©s' }}"
            loading="lazy" decoding="async"
            width="{{ section.settings.image_after.width }}"
            height="{{ section.settings.image_after.height }}"
            class="ba__img"
          >
        {%- else -%}
          <div class="ba__img" style="aspect-ratio:16/9;background:#2a2a2a;display:flex;align-items:center;justify-content:center;color:#666;">
            {{ 'lifestyle-2' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} BEFORE image (clipped overlay) {%- endcomment -%}
      <div class="ba__before" data-ba-before="{{ section.id }}">
        {%- if section.settings.image_before != blank -%}
          <img
            src="{{ section.settings.image_before | image_url: width: 1600 }}"
            srcset="{{ section.settings.image_before | image_url: width: 600 }} 600w, {{ section.settings.image_before | image_url: width: 1000 }} 1000w, {{ section.settings.image_before | image_url: width: 1600 }} 1600w"
            sizes="(max-width: 768px) 100vw, {{ section.settings.max_width }}px"
            alt="{{ section.settings.label_before | default: 'Antes' }}"
            loading="lazy" decoding="async"
            width="{{ section.settings.image_before.width }}"
            height="{{ section.settings.image_before.height }}"
            class="ba__img"
          >
        {%- else -%}
          <div class="ba__img" style="aspect-ratio:16/9;background:#555;display:flex;align-items:center;justify-content:center;color:#999;">
            {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} Slider controls {%- endcomment -%}
      <div class="ba__line" data-ba-line="{{ section.id }}"></div>
      <div class="ba__handle" data-ba-handle="{{ section.id }}" role="slider"
        aria-label="Comparar im√°genes"
        aria-valuemin="0" aria-valuemax="100"
        aria-valuenow="{{ section.settings.initial_position }}"
        tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <polyline points="8 4 4 8 8 12"></polyline>
          <polyline points="16 4 20 8 16 12"></polyline>
          <line x1="4" y1="8" x2="20" y2="8" opacity="0"></line>
        </svg>
      </div>

      {%- if section.settings.show_labels -%}
        <span class="ba__label ba__label--before">{{ section.settings.label_before | default: 'Antes' }}</span>
        <span class="ba__label ba__label--after">{{ section.settings.label_after | default: 'Despu√©s' }}</span>
      {%- endif -%}
    </div>

  </div>
</section>

<script>
  (function() {
    const container = document.querySelector('[data-ba="{{ section.id }}"]');
    if (!container) return;
    const before = container.querySelector('[data-ba-before="{{ section.id }}"]');
    const line = container.querySelector('[data-ba-line="{{ section.id }}"]');
    const handle = container.querySelector('[data-ba-handle="{{ section.id }}"]');
    const section = document.getElementById('BA-{{ section.id }}');
    let isDragging = false;

    /* Set container width CSS var for image sizing */
    function setContainerWidth() {
      container.style.setProperty('--ba-container-width', container.offsetWidth + 'px');
    }
    setContainerWidth();
    window.addEventListener('resize', setContainerWidth);

    function updatePosition(x) {
      const rect = container.getBoundingClientRect();
      let pos = ((x - rect.left) / rect.width) * 100;
      pos = Math.max(2, Math.min(98, pos));

      before.style.width = pos + '%';
      line.style.left = pos + '%';
      handle.style.left = pos + '%';
      handle.setAttribute('aria-valuenow', Math.round(pos));

      if (!section.classList.contains('ba--interacted')) {
        section.classList.add('ba--interacted');
      }
    }

    /* Mouse events */
    handle.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDragging = true;
    });
    container.addEventListener('mousedown', (e) => {
      isDragging = true;
      updatePosition(e.clientX);
    });
    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      updatePosition(e.clientX);
    });
    document.addEventListener('mouseup', () => { isDragging = false; });

    /* Touch events */
    handle.addEventListener('touchstart', (e) => {
      isDragging = true;
    }, { passive: true });
    container.addEventListener('touchstart', (e) => {
      isDragging = true;
      updatePosition(e.touches[0].clientX);
    }, { passive: true });
    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      updatePosition(e.touches[0].clientX);
    }, { passive: true });
    document.addEventListener('touchend', () => { isDragging = false; });

    /* Keyboard accessibility */
    handle.addEventListener('keydown', (e) => {
      const rect = container.getBoundingClientRect();
      const currentPercent = parseFloat(before.style.width) || {{ section.settings.initial_position }};
      let newPercent = currentPercent;

      if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
        newPercent = Math.max(2, currentPercent - 2);
        e.preventDefault();
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
        newPercent = Math.min(98, currentPercent + 2);
        e.preventDefault();
      }

      before.style.width = newPercent + '%';
      line.style.left = newPercent + '%';
      handle.style.left = newPercent + '%';
      handle.setAttribute('aria-valuenow', Math.round(newPercent));
      section.classList.add('ba--interacted');
    });
  })();
</script>

{% schema %}
{
  "name": "Before / After",
  "settings": [
    {
      "type": "text",
      "id": "subheading",
      "label": "Subt√≠tulo"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "T√≠tulo"
    },
    {
      "type": "header",
      "content": "üñº Im√°genes"
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "Imagen izquierda (antes)"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "Imagen derecha (despu√©s)"
    },
    {
      "type": "checkbox",
      "id": "show_labels",
      "label": "Mostrar etiquetas",
      "default": true
    },
    {
      "type": "text",
      "id": "label_before",
      "label": "Etiqueta izquierda",
      "default": "Antes"
    },
    {
      "type": "text",
      "id": "label_after",
      "label": "Etiqueta derecha",
      "default": "Despu√©s"
    },
    {
      "type": "header",
      "content": "‚öôÔ∏è Configuraci√≥n"
    },
    {
      "type": "range",
      "id": "initial_position",
      "min": 20,
      "max": 80,
      "step": 5,
      "unit": "%",
      "label": "Posici√≥n inicial del slider",
      "default": 50
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 600,
      "max": 1400,
      "step": 50,
      "unit": "px",
      "label": "Ancho m√°ximo",
      "default": 1000
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Redondeo",
      "default": 0
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Ancho completo",
      "default": false
    },
    {
      "type": "header",
      "content": "üé® Colores"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Color del texto"
    }
  ],
  "presets": [
    {
      "name": "Before / After",
      "settings": {
        "initial_position": 50,
        "show_labels": true
      }
    }
  ]
}
{% endschema %}
