{%- comment -%}
  Section: Main Collection — Rediseñada estilo Revolve editorial
  - Hero banner full-width con imagen + nombre superpuesto
  - Quick occasion filter tags (Ocasión:xxx) debajo del título
  - Filtros detallados: Talla, Color, Precio, Tipo de prenda
  - Layout limpio y elegante
  - Hover reveal segundo imagen + tallas
{%- endcomment -%}

{%- paginate collection.products by section.settings.products_per_page -%}

<section class="zara-collection" data-section-id="{{ section.id }}">

  {%- comment -%} ===== EDITORIAL HERO BANNER ===== {%- endcomment -%}
  <div class="zc-hero{% if collection.image %} zc-hero--has-image{% endif %}{% if section.settings.hero_full_width %} zc-hero--full{% endif %}">
    {%- if collection.image and section.settings.show_hero_image -%}
      <div class="zc-hero__media">
        <img
          src="{{ collection.image | image_url: width: 1920 }}"
          srcset="{{ collection.image | image_url: width: 600 }} 600w, {{ collection.image | image_url: width: 1000 }} 1000w, {{ collection.image | image_url: width: 1400 }} 1400w, {{ collection.image | image_url: width: 1920 }} 1920w"
          sizes="100vw"
          alt="{{ collection.title }}"
          loading="eager"
          fetchpriority="high"
          decoding="async"
          width="{{ collection.image.width }}"
          height="{{ collection.image.height }}"
          class="zc-hero__img"
        >
        <div class="zc-hero__overlay"></div>
      </div>
    {%- endif -%}
    <div class="zc-hero__content{% if collection.image and section.settings.show_hero_image %} zc-hero__content--over{% endif %}">
      <h1 class="zc-hero__title">{{ collection.title }}</h1>
      {%- if collection.description != blank and section.settings.show_description -%}
        <p class="zc-hero__desc">{{ collection.description | strip_html | truncatewords: 30 }}</p>
      {%- endif -%}
      <span class="zc-hero__count">{{ collection.products_count }} {% if collection.products_count == 1 %}producto{% else %}productos{% endif %}</span>
    </div>
  </div>

  {%- comment -%} ===== OCCASION QUICK FILTERS (tags with "Ocasión:" prefix) ===== {%- endcomment -%}
  {%- assign occasion_prefix = section.settings.occasion_group | default: 'Ocasión' -%}
  {%- assign has_occasion_tags = false -%}
  {%- for tag in collection.all_tags -%}
    {%- if tag contains occasion_prefix -%}
      {%- assign has_occasion_tags = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if has_occasion_tags -%}
    <div class="zc-occasion-bar page-width">
      <div class="zc-occasion-bar__inner">
        <a href="{{ collection.url }}" class="zc-occasion-tag{% unless current_tags.size > 0 %} is-active{% endunless %}">
          Todo
        </a>
        {%- for tag in collection.all_tags -%}
          {%- if tag contains occasion_prefix -%}
            {%- assign occasion_val = tag | split: ':' | last | strip -%}
            {%- if current_tags contains tag -%}
              <a href="{{ collection.url }}" class="zc-occasion-tag is-active">{{ occasion_val }}</a>
            {%- else -%}
              <a href="{{ collection.url }}/{{ tag | handleize }}" class="zc-occasion-tag">{{ occasion_val }}</a>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  {%- endif -%}

  <div class="page-width">

    {%- comment -%} ===== FILTER + SORT BAR ===== {%- endcomment -%}
    {%- comment -%} Count active storefront filters {%- endcomment -%}
    {%- assign bsd_active_filter_count = 0 -%}
    {%- for filter in collection.filters -%}
      {%- assign bsd_active_filter_count = bsd_active_filter_count | plus: filter.active_values.size -%}
    {%- endfor -%}

    <div class="zc-toolbar">
      <div class="zc-toolbar__left">
        <button class="zc-filter-toggle" onclick="document.querySelector('.zc-filters').classList.toggle('is-open'); this.classList.toggle('is-active');">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="10" y2="18"/></svg>
          <span>Filtros</span>
          {%- if bsd_active_filter_count > 0 -%}
            <span class="zc-filter-count">{{ bsd_active_filter_count }}</span>
          {%- endif -%}
        </button>
      </div>

      <div class="zc-toolbar__right">
        {%- comment -%} View Toggle {%- endcomment -%}
        <div class="zc-view-toggle">
          <button class="zc-view-btn{% if section.settings.default_columns == '2' %} is-active{% endif %}" onclick="setCollectionView(2, this)" aria-label="2 columnas">
            <svg width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="7" height="16" rx="1" fill="currentColor"/><rect x="9" y="0" width="7" height="16" rx="1" fill="currentColor"/></svg>
          </button>
          <button class="zc-view-btn{% if section.settings.default_columns == '3' %} is-active{% endif %}" onclick="setCollectionView(3, this)" aria-label="3 columnas">
            <svg width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="4.5" height="16" rx="1" fill="currentColor"/><rect x="5.75" y="0" width="4.5" height="16" rx="1" fill="currentColor"/><rect x="11.5" y="0" width="4.5" height="16" rx="1" fill="currentColor"/></svg>
          </button>
          <button class="zc-view-btn{% if section.settings.default_columns == '4' %} is-active{% endif %}" onclick="setCollectionView(4, this)" aria-label="4 columnas">
            <svg width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="3" height="16" rx="0.5" fill="currentColor"/><rect x="4.33" y="0" width="3" height="16" rx="0.5" fill="currentColor"/><rect x="8.67" y="0" width="3" height="16" rx="0.5" fill="currentColor"/><rect x="13" y="0" width="3" height="16" rx="0.5" fill="currentColor"/></svg>
          </button>
        </div>

        {%- comment -%} Sort {%- endcomment -%}
        <div class="zc-sort">
          <select id="ZaraCollectionSort" onchange="window.location.href = this.value;" aria-label="Ordenar por">
            {%- for option in collection.sort_options -%}
              <option
                value="{{ collection.url }}?sort_by={{ option.value }}"
                {% if collection.sort_by == option.value %}selected{% endif %}
              >
                {{ option.name }}
              </option>
            {%- endfor -%}
          </select>
        </div>
      </div>
    </div>

    {%- comment -%} ===== STOREFRONT FILTERS (tipo de prenda, talla, etc.) ===== {%- endcomment -%}
    <div class="zc-filters">

      {%- comment -%} Active filters strip {%- endcomment -%}
      {%- if bsd_active_filter_count > 0 -%}
        <div class="zc-active-filters">
          {%- for filter in collection.filters -%}
            {%- for value in filter.active_values -%}
              <a href="{{ value.url_to_remove }}" class="zc-active-tag">
                {{ value.label }}
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </a>
            {%- endfor -%}
          {%- endfor -%}
          <a href="{{ collection.url }}{% if current_tags %}/{{ current_tags | join: '+' }}{% endif %}" class="zc-clear-filters">Limpiar todo</a>
        </div>
      {%- endif -%}

      {%- comment -%} Filter groups from Storefront Filtering API {%- endcomment -%}
      {%- if collection.filters.size > 0 -%}
        <div class="zc-filter-groups">
          {%- for filter in collection.filters -%}
            {%- if filter.type == 'list' -%}
              {%- comment -%} Count values with products to avoid empty groups {%- endcomment -%}
              {%- assign available_values = 0 -%}
              {%- for value in filter.values -%}
                {%- if value.count > 0 or value.active -%}
                  {%- assign available_values = available_values | plus: 1 -%}
                {%- endif -%}
              {%- endfor -%}

              {%- if available_values > 0 -%}
                <div class="zc-filter-group is-open">
                  <button class="zc-filter-group__toggle" onclick="this.parentElement.classList.toggle('is-open')">
                    {{ filter.label }}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                  </button>
                  <div class="zc-filter-group__options">
                    {%- for value in filter.values -%}
                      {%- if value.count > 0 or value.active -%}
                        {%- if value.active -%}
                          <a href="{{ value.url_to_remove }}" class="zc-filter-tag is-active">
                            <span class="zc-filter-check">✓</span> {{ value.label }}
                          </a>
                        {%- else -%}
                          <a href="{{ value.url_to_add }}" class="zc-filter-tag">
                            {{ value.label }} <span class="zc-filter-tag__count">({{ value.count }})</span>
                          </a>
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}

            {%- elsif filter.type == 'price_range' -%}
              <div class="zc-filter-group is-open">
                <button class="zc-filter-group__toggle" onclick="this.parentElement.classList.toggle('is-open')">
                  {{ filter.label }}
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="zc-filter-group__options zc-filter-group__options--price">
                  <form class="zc-price-filter" action="{{ collection.url }}{% if current_tags %}/{{ current_tags | join: '+' }}{% endif %}" method="get">
                    {%- comment -%} Preserve existing filters {%- endcomment -%}
                    {%- for f in collection.filters -%}
                      {%- if f.type == 'list' -%}
                        {%- for val in f.active_values -%}
                          <input type="hidden" name="{{ val.param_name }}" value="{{ val.value }}">
                        {%- endfor -%}
                      {%- endif -%}
                    {%- endfor -%}
                    {%- if collection.sort_by -%}
                      <input type="hidden" name="sort_by" value="{{ collection.sort_by }}">
                    {%- endif -%}
                    <div class="zc-price-inputs">
                      <input type="number" name="{{ filter.min_value.param_name }}" placeholder="$ Min" value="{{ filter.min_value.value | divided_by: 100 }}" min="0" class="zc-price-input">
                      <span class="zc-price-sep">—</span>
                      <input type="number" name="{{ filter.max_value.param_name }}" placeholder="$ Max" value="{{ filter.max_value.value | divided_by: 100 }}" min="0" class="zc-price-input">
                      <button type="submit" class="zc-price-go">Ir</button>
                    </div>
                  </form>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- else -%}
        <p class="zc-filters__empty">No hay filtros disponibles.</p>
      {%- endif -%}
    </div>

    {%- comment -%} ===== PRODUCT GRID ===== {%- endcomment -%}
    {%- if collection.products.size > 0 -%}
      <div class="zc-products zc-products--{{ section.settings.default_columns }}" id="ZaraProductGrid">
        {%- for product in collection.products -%}
          <div class="zc-product" data-animate style="animation-delay: {{ forloop.index | times: 0.05 }}s;">
            <a href="{{ product.url }}" class="zc-product__link">
              <div class="zc-product__media">
                {%- if product.featured_image -%}
                  <img
                    src="{{ product.featured_image | image_url: width: 800 }}"
                    srcset="{{ product.featured_image | image_url: width: 300 }} 300w, {{ product.featured_image | image_url: width: 500 }} 500w, {{ product.featured_image | image_url: width: 800 }} 800w"
                    sizes="(max-width: 480px) 50vw, (max-width: 767px) 33vw, 25vw"
                    alt="{{ product.featured_image.alt | default: product.title }}"
                    loading="lazy"
                    decoding="async"
                    width="{{ product.featured_image.width }}"
                    height="{{ product.featured_image.height }}"
                    class="zc-product__img zc-product__img--primary"
                  >
                  {%- if product.images[1] != blank -%}
                    <img
                      src="{{ product.images[1] | image_url: width: 800 }}"
                      srcset="{{ product.images[1] | image_url: width: 300 }} 300w, {{ product.images[1] | image_url: width: 500 }} 500w, {{ product.images[1] | image_url: width: 800 }} 800w"
                      sizes="(max-width: 480px) 50vw, (max-width: 767px) 33vw, 25vw"
                      alt="{{ product.title }}"
                      loading="lazy"
                      decoding="async"
                      width="{{ product.images[1].width }}"
                      height="{{ product.images[1].height }}"
                      class="zc-product__img zc-product__img--hover"
                    >
                  {%- endif -%}
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {%- endif -%}

                {%- if product.compare_at_price > product.price -%}
                  <span class="zc-product__badge zc-product__badge--sale">
                    -{{ product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round }}%
                  </span>
                {%- endif -%}

                {%- unless product.available -%}
                  <span class="zc-product__badge zc-product__badge--sold">Agotado</span>
                {%- endunless -%}

                {%- if product.tags contains 'new' or product.tags contains 'nuevo' -%}
                  <span class="zc-product__badge zc-product__badge--new">New</span>
                {%- endif -%}

                {%- if product.available and section.settings.show_quick_sizes -%}
                  {%- for option in product.options_with_values -%}
                    {%- assign option_name_lower = option.name | downcase -%}
                    {%- if option_name_lower == 'size' or option_name_lower == 'talla' or option_name_lower == 'tamaño' -%}
                      <div class="zc-product__sizes">
                        {%- for value in option.values -%}
                          {%- assign variant_available = true -%}
                          {%- for variant in product.variants -%}
                            {%- if variant.option1 == value or variant.option2 == value or variant.option3 == value -%}
                              {%- unless variant.available -%}{%- assign variant_available = false -%}{%- endunless -%}
                            {%- endif -%}
                          {%- endfor -%}
                          <span class="zc-product__size{% unless variant_available %} zc-product__size--disabled{% endunless %}">
                            {{ value }}
                          </span>
                        {%- endfor -%}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              </div>

              <div class="zc-product__info">
                <h3 class="zc-product__title">{{ product.title }}</h3>
                <div class="zc-product__price">
                  {%- if product.compare_at_price > product.price -%}
                    <span class="zc-product__price--current zc-product__price--on-sale">{{ product.price | money }}</span>
                    <span class="zc-product__price--compare">{{ product.compare_at_price | money }}</span>
                  {%- else -%}
                    <span class="zc-product__price--current">{{ product.price | money }}</span>
                  {%- endif -%}
                </div>

                {%- if section.settings.show_color_swatches -%}
                  {%- for option in product.options_with_values -%}
                    {%- assign option_name_lower = option.name | downcase -%}
                    {%- if option_name_lower == 'color' or option_name_lower == 'colour' -%}
                      <div class="zc-product__colors">
                        {%- for value in option.values -%}
                          <span class="zc-product__color-swatch" title="{{ value }}" style="background-color: {{ value | handleize }};">
                            <span class="visually-hidden">{{ value }}</span>
                          </span>
                        {%- endfor -%}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              </div>
            </a>
          </div>
        {%- endfor -%}
      </div>

      {%- if paginate.pages > 1 -%}
        {% render 'pagination', paginate: paginate %}
      {%- endif -%}
    {%- else -%}
      <div class="zc-empty">
        <p>No se encontraron productos con estos filtros.</p>
        <a href="{{ collection.url }}" class="btn btn--secondary">Limpiar filtros</a>
      </div>
    {%- endif -%}
  </div>
</section>

{%- endpaginate -%}

<script>
  function setCollectionView(cols, btn) {
    const grid = document.getElementById('ZaraProductGrid');
    grid.className = grid.className.replace(/zc-products--\d/, 'zc-products--' + cols);
    document.querySelectorAll('.zc-view-btn').forEach(b => b.classList.remove('is-active'));
    btn.classList.add('is-active');
    localStorage.setItem('bs_collection_view', cols);
  }
  (function() {
    const saved = localStorage.getItem('bs_collection_view');
    if (saved) {
      const grid = document.getElementById('ZaraProductGrid');
      if (grid) grid.className = grid.className.replace(/zc-products--\d/, 'zc-products--' + saved);
      document.querySelectorAll('.zc-view-btn').forEach(b => b.classList.remove('is-active'));
      const idx = parseInt(saved) - 1;
      const btns = document.querySelectorAll('.zc-view-btn');
      if (btns[idx - 1]) btns[idx - 1].classList.add('is-active');
    }
  })();
</script>

{% schema %}
{
  "name": "Colección (Revolve style)",
  "settings": [
    {
      "type": "header",
      "content": "Hero de colección"
    },
    {
      "type": "checkbox",
      "id": "show_hero_image",
      "label": "Mostrar imagen hero de colección",
      "default": true,
      "info": "Usa la imagen de la colección como banner editorial"
    },
    {
      "type": "checkbox",
      "id": "hero_full_width",
      "label": "Hero a ancho completo",
      "default": true,
      "info": "La imagen ocupa todo el ancho de la pantalla"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Mostrar descripción",
      "default": true
    },
    {
      "type": "header",
      "content": "Filtros por ocasión"
    },
    {
      "type": "text",
      "id": "occasion_group",
      "label": "Nombre del grupo de ocasión",
      "default": "Ocasión",
      "info": "Los tags con formato 'Ocasión:Oficina' aparecen como filtros rápidos debajo del hero"
    },
    {
      "type": "header",
      "content": "Productos"
    },
    {
      "type": "select",
      "id": "default_columns",
      "label": "Columnas por defecto",
      "options": [
        { "value": "2", "label": "2 columnas" },
        { "value": "3", "label": "3 columnas" },
        { "value": "4", "label": "4 columnas" }
      ],
      "default": "4"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "label": "Productos por página",
      "default": 24
    },
    {
      "type": "checkbox",
      "id": "show_quick_sizes",
      "label": "Mostrar tallas en hover",
      "default": true,
      "info": "Muestra las tallas disponibles al pasar el cursor"
    },
    {
      "type": "checkbox",
      "id": "show_color_swatches",
      "label": "Mostrar swatches de color",
      "default": true
    }
  ]
}
{% endschema %}
