{%- comment -%}
  Section: Image Crossfade ‚Äî Transici√≥n de imagen al hacer scroll
  Dos im√°genes apiladas. Al hacer scroll, la primera se desvanece revelando la segunda.
  Usa position: sticky para fijar el visual mientras el scroll avanza.
{%- endcomment -%}

{%- assign section_height = section.settings.scroll_distance | times: 100 -%}

<style>
  #XF-{{ section.id }} {
    position: relative;
    height: {{ section_height }}vh;
    {%- if section.settings.background_color != blank and section.settings.background_color != 'rgba(0,0,0,0)' -%}
      background-color: {{ section.settings.background_color }};
    {%- endif -%}
  }

  #XF-{{ section.id }} .xf__sticky {
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  /* Images */
  #XF-{{ section.id }} .xf__images {
    position: absolute;
    inset: 0;
  }
  #XF-{{ section.id }} .xf__img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #XF-{{ section.id }} .xf__img--top {
    z-index: 2;
    will-change: opacity;
  }
  #XF-{{ section.id }} .xf__img--base {
    z-index: 1;
  }

  /* Progress bar */
  #XF-{{ section.id }} .xf__progress {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    width: 120px;
    height: 2px;
    background: rgba(255,255,255,0.3);
    border-radius: 1px;
    overflow: hidden;
  }
  #XF-{{ section.id }} .xf__progress-bar {
    height: 100%;
    width: 0%;
    background: #fff;
    transition: width 50ms linear;
  }

  /* Content overlay */
  #XF-{{ section.id }} .xf__content {
    position: absolute;
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 2rem;
    color: #fff;

    /* Position */
    {%- case section.settings.text_position -%}
      {%- when 'top' -%}
        top: 10%; left: 50%; transform: translateX(-50%);
      {%- when 'center' -%}
        top: 50%; left: 50%; transform: translate(-50%, -50%);
      {%- when 'bottom' -%}
        bottom: 10%; left: 50%; transform: translateX(-50%);
    {%- endcase -%}
    width: min(90%, 700px);
  }

  #XF-{{ section.id }} .xf__content-heading {
    font-size: clamp(2rem, 5vw, 4rem);
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 0 0 1rem;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }
  #XF-{{ section.id }} .xf__content-sub {
    font-size: clamp(0.85rem, 1.5vw, 1.1rem);
    letter-spacing: 0.05em;
    line-height: 1.6;
    margin: 0 0 1.5rem;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease 0.2s, transform 0.8s ease 0.2s;
  }
  #XF-{{ section.id }} .xf__cta {
    display: inline-block;
    padding: 0.75rem 2.5rem;
    border: 1px solid #fff;
    color: #fff;
    text-decoration: none;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    transition: background 0.3s, color 0.3s, opacity 0.8s ease 0.4s, transform 0.8s ease 0.4s;
    opacity: 0;
    transform: translateY(20px);
  }
  #XF-{{ section.id }} .xf__cta:hover {
    background: #fff;
    color: #1a1a1a;
  }

  /* Text appears as crossfade progresses */
  #XF-{{ section.id }}.xf--text-visible .xf__content-heading,
  #XF-{{ section.id }}.xf--text-visible .xf__content-sub,
  #XF-{{ section.id }}.xf--text-visible .xf__cta {
    opacity: 1;
    transform: translateY(0);
  }

  /* Gradient overlay for text readability */
  #XF-{{ section.id }} .xf__gradient {
    position: absolute;
    inset: 0;
    z-index: 3;
    background: radial-gradient(ellipse at center, rgba(0,0,0,{{ section.settings.overlay_opacity }}) 0%, transparent 70%);
    pointer-events: none;
  }

  /* Labels */
  #XF-{{ section.id }} .xf__label {
    position: absolute;
    z-index: 6;
    top: 2rem;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.7);
    padding: 0.4rem 1rem;
    background: rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    transition: opacity 0.4s;
  }
  #XF-{{ section.id }} .xf__label--before { left: 2rem; }
  #XF-{{ section.id }} .xf__label--after { right: 2rem; opacity: 0; }
  #XF-{{ section.id }}.xf--crossed .xf__label--before { opacity: 0; }
  #XF-{{ section.id }}.xf--crossed .xf__label--after { opacity: 1; }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    #XF-{{ section.id }} { height: auto !important; }
    #XF-{{ section.id }} .xf__sticky { position: relative; height: auto; min-height: 80vh; }
    #XF-{{ section.id }} .xf__img--top { display: none; }
    #XF-{{ section.id }} .xf__content-heading,
    #XF-{{ section.id }} .xf__content-sub,
    #XF-{{ section.id }} .xf__cta { opacity: 1; transform: none; transition: none; }
  }
</style>

<section id="XF-{{ section.id }}" class="xf" data-section-id="{{ section.id }}">
  <div class="xf__sticky">
    <div class="xf__images">
      {%- if section.settings.image_after != blank -%}
        <img
          src="{{ section.settings.image_after | image_url: width: 2000 }}"
          srcset="{{ section.settings.image_after | image_url: width: 800 }} 800w, {{ section.settings.image_after | image_url: width: 1400 }} 1400w, {{ section.settings.image_after | image_url: width: 2000 }} 2000w"
          sizes="100vw"
          alt="{{ section.settings.image_after.alt | default: 'Imagen 2' }}"
          loading="lazy" decoding="async"
          width="{{ section.settings.image_after.width }}"
          height="{{ section.settings.image_after.height }}"
          class="xf__img xf__img--base"
        >
      {%- else -%}
        <div class="xf__img xf__img--base" style="background:#2a2a2a;"></div>
      {%- endif -%}

      {%- if section.settings.image_before != blank -%}
        <img
          src="{{ section.settings.image_before | image_url: width: 2000 }}"
          srcset="{{ section.settings.image_before | image_url: width: 800 }} 800w, {{ section.settings.image_before | image_url: width: 1400 }} 1400w, {{ section.settings.image_before | image_url: width: 2000 }} 2000w"
          sizes="100vw"
          alt="{{ section.settings.image_before.alt | default: 'Imagen 1' }}"
          loading="lazy" decoding="async"
          width="{{ section.settings.image_before.width }}"
          height="{{ section.settings.image_before.height }}"
          class="xf__img xf__img--top"
          data-xf-top="{{ section.id }}"
        >
      {%- else -%}
        <div class="xf__img xf__img--top" data-xf-top="{{ section.id }}" style="background:#555;"></div>
      {%- endif -%}
    </div>

    <div class="xf__gradient"></div>

    {%- if section.settings.show_labels -%}
      <span class="xf__label xf__label--before">{{ section.settings.label_before | default: 'Antes' }}</span>
      <span class="xf__label xf__label--after">{{ section.settings.label_after | default: 'Despu√©s' }}</span>
    {%- endif -%}

    {%- if section.settings.heading != blank or section.settings.subheading != blank or section.settings.button_label != blank -%}
      <div class="xf__content">
        {%- if section.settings.heading != blank -%}
          <h2 class="xf__content-heading">{{ section.settings.heading }}</h2>
        {%- endif -%}
        {%- if section.settings.subheading != blank -%}
          <p class="xf__content-sub">{{ section.settings.subheading }}</p>
        {%- endif -%}
        {%- if section.settings.button_label != blank -%}
          <a href="{{ section.settings.button_link | default: '#' }}" class="xf__cta">{{ section.settings.button_label }}</a>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if section.settings.show_progress -%}
      <div class="xf__progress"><div class="xf__progress-bar" data-xf-bar="{{ section.id }}"></div></div>
    {%- endif -%}
  </div>
</section>

<script>
  (function() {
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const section = document.getElementById('XF-{{ section.id }}');
    if (!section) return;
    const topImg = section.querySelector('[data-xf-top="{{ section.id }}"]');
    const bar = section.querySelector('[data-xf-bar="{{ section.id }}"]');

    let ticking = false;

    function onScroll() {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(function() {
        const rect = section.getBoundingClientRect();
        const sectionH = section.offsetHeight;
        const viewH = window.innerHeight;

        /* Progress: 0 when section top hits viewport top, 1 when section bottom hits viewport bottom */
        const scrolled = -rect.top;
        const scrollRange = sectionH - viewH;
        const progress = Math.max(0, Math.min(1, scrolled / scrollRange));

        /* Crossfade */
        if (topImg) topImg.style.opacity = 1 - progress;

        /* Progress bar */
        if (bar) bar.style.width = (progress * 100) + '%';

        /* Label swap at 50% */
        if (progress > 0.5) {
          section.classList.add('xf--crossed');
        } else {
          section.classList.remove('xf--crossed');
        }

        /* Text reveal at 40% */
        if (progress > 0.4) {
          section.classList.add('xf--text-visible');
        } else {
          section.classList.remove('xf--text-visible');
        }

        ticking = false;
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  })();
</script>

{% schema %}
{
  "name": "Image Crossfade",
  "settings": [
    {
      "type": "header",
      "content": "üñº Im√°genes"
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "Imagen inicial (se desvanece)"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "Imagen final (se revela)"
    },
    {
      "type": "checkbox",
      "id": "show_labels",
      "label": "Mostrar etiquetas Antes/Despu√©s",
      "default": true
    },
    {
      "type": "text",
      "id": "label_before",
      "label": "Etiqueta imagen 1",
      "default": "Antes"
    },
    {
      "type": "text",
      "id": "label_after",
      "label": "Etiqueta imagen 2",
      "default": "Despu√©s"
    },
    {
      "type": "header",
      "content": "‚úçÔ∏è Texto overlay"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "T√≠tulo"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subt√≠tulo"
    },
    {
      "type": "select",
      "id": "text_position",
      "label": "Posici√≥n del texto",
      "options": [
        { "value": "top", "label": "Arriba" },
        { "value": "center", "label": "Centro" },
        { "value": "bottom", "label": "Abajo" }
      ],
      "default": "center"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Texto del bot√≥n"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Enlace del bot√≥n"
    },
    {
      "type": "header",
      "content": "‚öôÔ∏è Configuraci√≥n"
    },
    {
      "type": "range",
      "id": "scroll_distance",
      "min": 2,
      "max": 5,
      "step": 1,
      "label": "Distancia de scroll (pantallas)",
      "default": 3,
      "info": "Cu√°ntas pantallas dura el efecto. M√°s alto = transici√≥n m√°s lenta"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 0.6,
      "step": 0.1,
      "label": "Oscurecimiento del overlay",
      "default": 0.2
    },
    {
      "type": "checkbox",
      "id": "show_progress",
      "label": "Mostrar barra de progreso",
      "default": true
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo"
    }
  ],
  "presets": [
    {
      "name": "Image Crossfade",
      "settings": {
        "scroll_distance": 3,
        "show_labels": true
      }
    }
  ]
}
{% endschema %}
